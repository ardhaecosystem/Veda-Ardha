services:
  falkordb:
    image: falkordb/falkordb:latest
    container_name: veda-falkordb
    restart: unless-stopped
    ports:
      - "6379:6379"
      - "3000:3000"
    environment:
      - REDIS_ARGS=--requirepass ${FALKORDB_PASSWORD} --appendonly yes --appendfsync everysec --maxmemory 4gb --maxmemory-policy allkeys-lru
      - FALKORDB_ARGS=THREAD_COUNT 4 CACHE_SIZE 50 TIMEOUT_MAX 60000 QUERY_MEM_CAPACITY 104857600
    volumes:
      - falkordb_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${FALKORDB_PASSWORD}", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 5G
        reservations:
          memory: 2G

  # === NEW: Dedicated Redis for Veda's Cognitive State ===
  veda-cognitive-redis:
    image: redis:7-alpine
    container_name: veda-cognitive-redis
    restart: unless-stopped
    ports:
      - "6380:6379"  # Expose on 6380 to avoid conflict with FalkorDB
    command: >
      redis-server
      --appendonly yes
      --appendfsync everysec
      --save 900 1
      --save 300 10
      --save 60 10000
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru
      --tcp-backlog 511
      --timeout 300
      --tcp-keepalive 60
    volumes:
      - veda_cognitive_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 5s
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          memory: 128M
    networks:
      - veda-network

  searxng:
    image: docker.io/searxng/searxng:latest
    container_name: veda-searxng
    restart: unless-stopped
    ports:
      - "8888:8080"
    volumes:
      - ./config/searxng:/etc/searxng:rw
    environment:
      - UWSGI_WORKERS=2
      - UWSGI_THREADS=2
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID
    deploy:
      resources:
        limits:
          memory: 512M
    networks:
      - veda-network

  searxng-redis:
    image: redis:alpine
    container_name: veda-searxng-redis
    restart: unless-stopped
    command: redis-server --save "" --appendonly "no"
    deploy:
      resources:
        limits:
          memory: 128M
    networks:
      - veda-network

  open-webui:
    image: ghcr.io/open-webui/open-webui:main
    container_name: veda-webui
    restart: unless-stopped
    ports:
      - "3001:8080"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - WEBUI_SECRET_KEY=${SECRET_KEY}
      - WEBUI_URL=https://veda.humanth.in
      - CORS_ALLOW_ORIGIN=https://veda.humanth.in
      - WEBUI_NAME=Veda
      - WEBUI_AUTH=true
      - ENABLE_SIGNUP=true
      - ENABLE_API_KEYS=true
      - OPENAI_API_BASE_URL=http://host.docker.internal:8000/v1
      - OPENAI_API_KEY=veda-local-key
      - AIOHTTP_CLIENT_TIMEOUT=300
      - ENABLE_WEBSOCKET_SUPPORT=true
      - WEBSOCKET_MANAGER=redis
      - WEBSOCKET_REDIS_URL=redis://searxng-redis:6379/1
    volumes:
      - open_webui_data:/app/backend/data
    depends_on:
      - falkordb
      - searxng-redis
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 1G
    networks:
      - veda-network

volumes:
  falkordb_data:
    driver: local
  open_webui_data:
    driver: local
  veda_cognitive_data:  # NEW: Persistent storage for emotional state
    driver: local

networks:
  veda-network:  # NEW: Explicit network for service communication
    driver: bridge
