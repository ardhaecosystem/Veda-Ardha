services:
  falkordb:
    image: falkordb/falkordb:latest
    container_name: veda-falkordb
    restart: unless-stopped
    ports:
      - "6379:6379"
      - "3000:3000"
    environment:
      - REDIS_ARGS=--requirepass ${FALKORDB_PASSWORD} --appendonly yes --appendfsync everysec --maxmemory 4gb --maxmemory-policy allkeys-lru
      - FALKORDB_ARGS=THREAD_COUNT 4 CACHE_SIZE 50 TIMEOUT_MAX 60000 QUERY_MEM_CAPACITY 104857600
    volumes:
      - falkordb_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${FALKORDB_PASSWORD}", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 5G
        reservations:
          memory: 2G

  searxng:
    image: docker.io/searxng/searxng:latest
    container_name: veda-searxng
    restart: unless-stopped
    ports:
      - "8888:8080"
    volumes:
      - ./config/searxng:/etc/searxng:rw
    environment:
      - UWSGI_WORKERS=2
      - UWSGI_THREADS=2
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID
    deploy:
      resources:
        limits:
          memory: 512M

  searxng-redis:
    image: redis:alpine
    container_name: veda-searxng-redis
    restart: unless-stopped
    command: redis-server --save "" --appendonly "no"
    deploy:
      resources:
        limits:
          memory: 128M

  open-webui:
    image: ghcr.io/open-webui/open-webui:main
    container_name: veda-webui
    restart: unless-stopped
    ports:
      - "3001:8080"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - WEBUI_SECRET_KEY=${SECRET_KEY}
      - WEBUI_URL=https://veda.humanth.in  # CHANGED: Use IP instead of domain for now
      - CORS_ALLOW_ORIGIN=https://veda.humanth.in
      - WEBUI_NAME=Veda
      - WEBUI_AUTH=true
      - ENABLE_SIGNUP=true  # Changed back to true
      - ENABLE_API_KEYS=true
      - OPENAI_API_BASE_URL=http://host.docker.internal:8000/v1
      - OPENAI_API_KEY=veda-local-key
      - AIOHTTP_CLIENT_TIMEOUT=300
      - ENABLE_WEBSOCKET_SUPPORT=true  # NEW: Explicitly enable
      - WEBSOCKET_MANAGER=redis  # NEW: Use Redis for WebSocket
      - WEBSOCKET_REDIS_URL=redis://searxng-redis:6379/1  # NEW: Connect to existing Redis
    volumes:
      - open_webui_data:/app/backend/data
    depends_on:
      - falkordb
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 1G

volumes:
  falkordb_data:
  open_webui_data:
